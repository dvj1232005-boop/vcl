<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An Quy Cháº¿ â€“ ÄÄƒng kÃ½ ca lÃ m</title>

<meta name="theme-color" content="#0b3d2e">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AnQuyChe">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#7f1d1d,#064e3b);
  min-height:100vh;
}
.hidden{display:none}
.container{max-width:420px;margin:auto;padding:20px}
.card{background:#fff;border-radius:22px;padding:20px;box-shadow:0 25px 50px rgba(0,0,0,.25)}
.sub{font-size:13px;color:#555}
.day{font-weight:700;margin-top:14px}
button{
  width:100%;padding:14px;border:none;border-radius:16px;
  background:#b91c1c;color:#fff;font-weight:600;margin-top:10px
}
.badge{
  display:inline-block;background:#14532d;color:#fff;
  padding:6px 10px;border-radius:999px;font-size:13px;margin:4px
}
.shiftBox{background:#f1f5f9;border-radius:14px;padding:10px;margin:8px 0}
footer{text-align:center;margin-top:16px;font-size:12px;color:#eee}
</style>
</head>

<body>

<div class="container" id="app">
  <div class="card">
    <h2>ÄÄƒng kÃ½ ca lÃ m</h2>
    <div class="sub">Tuáº§n hiá»‡n táº¡i â€¢ An Quy Cháº¿</div>
    <div id="lockStatus" class="sub"></div>

    <input id="name" placeholder="Nháº­p tÃªn nhÃ¢n viÃªn">
    <input id="pin" placeholder="Nháº­p mÃ£ PIN quáº£n lÃ½" class="hidden">
    <div id="form"></div>
    <button id="submitBtn">XÃ¡c nháº­n Ä‘Äƒng kÃ½</button>
  </div>

  <div class="card hidden" id="managerBox">
    <h2>Tá»•ng há»£p Ä‘Äƒng kÃ½</h2>
    <button onclick="exportPDF()">ğŸ“„ Xuáº¥t PDF</button>
    <button id="clearBtn">ğŸ—‘ï¸ XÃ³a toÃ n bá»™ lá»‹ch tuáº§n nÃ y</button>
    <div id="summary"></div>
  </div>

  <footer>Â© 2025 An Quy Cháº¿ â€¢ Developed by ÄÃ o ÄÄƒng TÃ¹ng</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyCK6yfVr9VBMGwhbvYMXkJqMoRjo4Om2LM",
  databaseURL:"https://an-quy-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = getDatabase(app);

const DAYS=["T2","T3","T4","T5","T6","T7","CN"];
const SHIFTS=["C1","C2","C3","F1","F2","2C(C1+C2)","2C(C2+C3)"];
let cachedData={};

document.getElementById("submitBtn").onclick=async()=>{
  const ten=name.value.trim();
  if(!ten) return alert("Nháº­p tÃªn");

  if(ten==="quanly"){
    pin.classList.remove("hidden");
    if(pin.value!=="2005") return alert("Sai PIN");
    showManager();return;
  }

  const lich={};
  DAYS.forEach(d=>{
    const s=document.getElementById(d)?.value;
    if(s) lich[d]=s;
  });
  if(!Object.keys(lich).length) return alert("ChÆ°a chá»n ca");
  await set(ref(db,"dangKy/"+ten),{lich});
  alert("ÄÃ£ gá»­i");
};

async function showManager(){
  managerBox.classList.remove("hidden");
  summary.innerHTML="";
  const snap=await get(ref(db,"dangKy"));
  cachedData={};

  snap.forEach(n=>{
    const ten=n.key;
    Object.entries(n.val().lich||{}).forEach(([d,c])=>{
      cachedData[d]??={};
      cachedData[d][c]??=[];
      cachedData[d][c].push(ten);
    });
  });

  DAYS.forEach(d=>{
    if(!cachedData[d]) return;
    summary.innerHTML+=`<div class="day">${d}</div>`;
    SHIFTS.forEach(s=>{
      if(!cachedData[d][s]) return;
      summary.innerHTML+=`
        <div class="shiftBox">
          <b>${s}</b><br>
          ${cachedData[d][s].map(n=>`<span class="badge">${n}</span>`).join("")}
        </div>`;
    });
  });
}

/* ===== PDF EXPORT ===== */
window.exportPDF=function(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  let y=10;

  doc.text("Lá»ŠCH ÄÄ‚NG KÃ CA LÃ€M - AN QUY CHáº¾",10,y); y+=10;

  DAYS.forEach(d=>{
    if(!cachedData[d]) return;
    doc.text(d,10,y); y+=8;

    SHIFTS.forEach(s=>{
      if(!cachedData[d][s]) return;
      doc.text(`- ${s}: ${cachedData[d][s].join(", ")}`,12,y);
      y+=8;
      if(y>280){ doc.addPage(); y=10; }
    });
  });

  doc.save("lich-ca-lam.pdf");
};

clearBtn.onclick=async()=>{
  if(confirm("XÃ³a toÃ n bá»™?")){
    await remove(ref(db,"dangKy"));
    location.reload();
  }
};
</script>
</body>
</html>

