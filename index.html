<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>An Quy Cháº¿ â€“ ÄÄƒng kÃ½ ca</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0ea5a4">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ===== THEME ===== */
:root{
  --bg:#020617;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#0f172a;
  --primary:#0ea5a4;
}
.light{
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --border:#e2e8f0;
  --primary:#0ea5a4;
}

/* ===== BASE ===== */
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  transition:.3s;
}
header{
  padding:14px 16px;
  background:linear-gradient(90deg,var(--primary),#22d3ee);
  font-weight:700;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:#001014;
}
button{
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:600;
  background:var(--primary);
  color:#001014;
  transition:.2s;
}
button:active{transform:scale(.96)}
select,input{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}
.card{
  margin:16px;
  padding:16px;
  border-radius:18px;
  border:1px solid var(--border);
  background:var(--card);
  animation:fadeUp .4s ease;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:none}
}
.hidden{display:none}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
td,th{
  border:1px solid var(--border);
  padding:10px;
  text-align:center;
}

/* ===== SELECTED DAY ===== */
.day-selected{
  background:rgba(14,165,164,.15);
  border-left:4px solid var(--primary);
}
.day-selected td:first-child::after{
  content:" âœ“";
  color:var(--primary);
  font-weight:700;
}

/* ===== DESKTOP CENTER ===== */
@media(min-width:768px){
  .card{max-width:500px;margin:24px auto}
}
</style>
</head>

<body>

<header>
  <span>AN QUY CHáº¾ â€“ ÄÄ‚NG KÃ CA</span>
  <button onclick="toggleTheme()">ğŸŒ™</button>
</header>

<!-- STAFF REGISTER -->
<div class="card" id="staffBox">
  <h3>ğŸ—“ï¸ ÄÄƒng kÃ½ ca lÃ m trong tuáº§n</h3>

  <table>
    <thead>
      <tr><th>Thá»©</th><th>Ca</th></tr>
    </thead>
    <tbody id="scheduleTable"></tbody>
  </table>

  <input id="nameInput" placeholder="Nháº­p tÃªn (Quáº£n lÃ½ nháº­p QuanLy)">
  <button id="submitBtn" onclick="submitAll()">XÃ¡c nháº­n Ä‘Äƒng kÃ½</button>

  <p style="font-size:13px;color:var(--muted)">
    NgÃ y khÃ´ng lÃ m cÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng.
  </p>
</div>

<!-- MANAGER -->
<div class="card hidden" id="managerBox">
  <h3>ğŸ“Š Quáº£n lÃ½ Ä‘Äƒng kÃ½ ca</h3>
  <select id="mDay"></select>
  <select id="mShift"></select>
  <div id="manageTable"></div>
</div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig={
  apiKey:"YOUR_API_KEY",
  databaseURL:"https://YOUR_PROJECT_ID.firebaseio.com",
  projectId:"YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ===== DATA ===== */
const days=["T2","T3","T4","T5","T6","T7","CN"];
const shifts=["","C1","F1","C2","F2","C3"];

/* ===== WEEK ===== */
function getWeek(){
  const d=new Date();
  d.setDate(d.getDate()+3-(d.getDay()+6)%7);
  const w1=new Date(d.getFullYear(),0,4);
  return d.getFullYear()+"-W"+
    String(1+Math.round(((d-w1)/86400000-3+(w1.getDay()+6)%7)/7)).padStart(2,"0");
}
const week=getWeek();

/* ===== BUILD TABLE ===== */
scheduleTable.innerHTML = days.map(d=>`
  <tr id="row-${d}">
    <td>${d}</td>
    <td>
      <select data-day="${d}" onchange="markDay('${d}', this.value)">
        ${shifts.map(s=>`
          <option value="${s}">${s || "â€” KhÃ´ng lÃ m â€”"}</option>
        `).join("")}
      </select>
    </td>
  </tr>
`).join("");

/* ===== MARK DAY ===== */
function markDay(day,value){
  const row=document.getElementById("row-"+day);
  value ? row.classList.add("day-selected")
        : row.classList.remove("day-selected");
}

/* ===== SUBMIT (FIX iOS) ===== */
function submitAll(){
  const btn = document.getElementById("submitBtn");
  const name = nameInput.value.trim();

  if(!name){
    alert("ChÆ°a nháº­p tÃªn");
    return;
  }

  // Quáº£n lÃ½
  if(name === "QuanLy"){
    staffBox.classList.add("hidden");
    managerBox.classList.remove("hidden");
    initManager();
    return;
  }

  const updates = {};
  document.querySelectorAll("select[data-day]").forEach(sel=>{
    if(sel.value){
      updates[`registrations/${week}/${sel.dataset.day}/${sel.value}/${name}`] = true;
    }
  });

  if(Object.keys(updates).length === 0){
    alert("Báº¡n chÆ°a chá»n ca nÃ o");
    return;
  }

  btn.disabled = true;
  btn.innerText = "â³ Äang gá»­i...";

  db.ref().update(updates)
    .then(()=>{
      btn.innerText = "âœ… ÄÃ£ ghi nháº­n";
      setTimeout(()=>{
        btn.innerText = "XÃ¡c nháº­n Ä‘Äƒng kÃ½";
        btn.disabled = false;
      },1200);
      nameInput.value = "";
    })
    .catch(err=>{
      alert(err.message);
      btn.disabled = false;
      btn.innerText = "XÃ¡c nháº­n Ä‘Äƒng kÃ½";
    });
}

/* ===== MANAGER ===== */
function initManager(){
  mDay.innerHTML=days.map(d=>`<option>${d}</option>`).join("");
  mShift.innerHTML=shifts.slice(1).map(s=>`<option>${s}</option>`).join("");
  mDay.onchange=mShift.onchange=loadManager;
  loadManager();
}
function loadManager(){
  db.ref(`registrations/${week}/${mDay.value}/${mShift.value}`)
    .once("value",snap=>{
      let html="<table><tr><th>NhÃ¢n viÃªn Ä‘Äƒng kÃ½</th></tr>";
      snap.forEach(c=>html+=`<tr><td>${c.key}</td></tr>`);
      html+="</table>";
      manageTable.innerHTML=html;
    });
}

/* ===== THEME ===== */
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.theme=document.body.classList.contains("light")?"light":"dark";
}
if(localStorage.theme==="light"){
  document.body.classList.add("light");
}

/* ===== SERVICE WORKER ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
